
# Object Level of Detail (LoD) (Schema)

`ogc.chekdbp.templates.object-lod` *v0.1*

Creates a rule to validate the LoD of a given element or set of elements

[*Status*](http://www.opengis.net/def/status): Under development

## Description

This template can be used to generate rules that verify the level of detail (LoD) of a given set of objects and/or
the presence of child objects.

**Note**: The rules generated by this template will not require the existence of at least one of the selected
elements (i.e., `path`/`idPatterns`), only that, when present, they must comply with the requirements. 

## `objectSelector`

The `objectSelector` can contain the following properties:

  * Either a `path` array or an `idPatterns` array. Whichever is present will be used to determine the objects that
    will be selected for checking.
    * `path` can be used to declare a hierarchy (parent - child - grandchild - ...) that will be used for matching inside
      the dataset. If only one class (e.g., `Building`) is provided, all objects of that class will be selected. Otherwise,
      the last element will be selected, as long as it is the child (`hasChild`) of the previous one, and that of its
      preceding object, and so on.
    * `idPatterns` can contain a list of regular expressions that will be used to select the elements that will
      be checked.
  * Optionally, a `requireSubPath` array of object classes can be provided. This will add a requirement that the
    objects selected with `path` or `idPatterns` contain a given object hierarchy within themselves. When using
    `requireSubPath`, `geometrySurface` and LoD checks will refer to its last element (overriding the selector
    above).
  * Additionally, a `geometrySurface` value can be included to require the presence of a surface with a specific
    geometry inside the selected element. If provided, LoD checks will be done against this geometry.

## `lod`

The `lod` property is optional. When present, a validation rule will be added for the level of detail of the
target object (defined with `objectSelector`). Otherwise, no LoD checks will be performed, and only `requireSubPath`
and/or `geometrySurface` presence validations will be done.

`lod` must contain one of the following subproperties:

  * `min`: a minimum value for LoD. Extended LoDs (e.g., "2.1") are supported, in which case the requirement will
    be applied to both components (e.g., "X.Y" where "X" is at least 2, and "Y" is at least 1).
  * `regex`: a regular expression to match the LoD against.

## Examples

### Minimum LoD 2.1+ for buildings
#### json
```json
{
  "id": "my-rule",
  "label": "My sample rule for buildings",
  "message": "Building has LoD less than 2.1",
  "objectSelector": {
    "path": [
      "Building"
    ]
  },
  "lod": {
    "min": "2.1"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "My sample rule for buildings",
      "description": null,
      "message": "Building has LoD less than 2.1",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?this a city:Building .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^[2-4]\\\\.[1-4]$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "Building has LoD less than 2.1" ;
    sh:name "My sample rule for buildings" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^[2-4]\\\\.[1-4]$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?this a city:Building .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ] .


```


### Minumum LoD 3 for buildings
#### json
```json
{
  "id": "my-rule",
  "label": "My sample rule for buildings",
  "message": "Building has LoD less than 3",
  "objectSelector": {
    "path": [
      "Building"
    ]
  },
  "lod": {
    "min": "3"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "My sample rule for buildings",
      "description": null,
      "message": "Building has LoD less than 3",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?this a city:Building .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^[3-4](\\\\.[0-4])?$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "Building has LoD less than 3" ;
    sh:name "My sample rule for buildings" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^[3-4](\\\\.[0-4])?$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?this a city:Building .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ] .


```


### Minumum LoD 3.2 for WallSurface in Buildings
#### json
```json
{
  "id": "my-rule",
  "label": "My sample rule for buildings",
  "message": "Building is missing WallSurface with LoD at least 3.2",
  "objectSelector": {
    "path": [
      "Building"
    ],
    "geometrySurface": "WallSurface"
  },
  "lod": {
    "min": "3.2"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "My sample rule for buildings",
      "description": null,
      "message": "Building is missing WallSurface with LoD at least 3.2",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?this a city:Building .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?surface a city:WallSurface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^[3-4]\\\\.[2-4]$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "Building is missing WallSurface with LoD at least 3.2" ;
    sh:name "My sample rule for buildings" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?surface a city:WallSurface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^[3-4]\\\\.[2-4]$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?this a city:Building .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ] .


```


### Mininum LoD with regular expression for GroundSurface of Building / BuildingPart
#### json
```json
{
  "id": "my-rule",
  "label": "My sample rule for buildings",
  "message": "BuildingPart has LoD less than 2.2",
  "objectSelector": {
    "path": [
      "Building",
      "BuildingPart"
    ],
    "geometrySurface": "GroundSurface"
  },
  "lod": {
    "regex": "^(2\\.[2-4]|[34](\\.*)?)$"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "My sample rule for buildings",
      "description": null,
      "message": "BuildingPart has LoD less than 2.2",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?obj0 a city:Building .\n  ?obj0 city:hasChild ?this .\n  ?this a city:BuildingPart .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?surface a city:GroundSurface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^(2\\.[2-4]|[34](\\.*)?)$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "BuildingPart has LoD less than 2.2" ;
    sh:name "My sample rule for buildings" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?surface a city:GroundSurface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^(2\\.[2-4]|[34](\\.*)?)$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?obj0 a city:Building .
  ?obj0 city:hasChild ?this .
  ?this a city:BuildingPart .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ] .


```


### Require that all BuildingPart's inside Building's have at least one BuildingInstallation with a WallSurface of LoD >= 2.
#### json
```json
{
  "id": "my-rule",
  "label": "My sample rule for buildings",
  "message": "BuildingPart lacks BuildingInstallation, or BuildingInstallation inside BuildingPart is missing WallSurface with LoD >= 2",
  "objectSelector": {
    "path": [
      "Building",
      "BuildingPart"
    ],
    "requiredSubPath": [
      "BuildingInstallation"
    ],
    "geometrySurface": "WallSurface"
  },
  "lod": {
    "min": "2"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "My sample rule for buildings",
      "description": null,
      "message": "BuildingPart lacks BuildingInstallation, or BuildingInstallation inside BuildingPart is missing WallSurface with LoD >= 2",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?obj0 a city:Building .\n  ?obj0 city:hasChild ?this .\n  ?this a city:BuildingPart .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasChild ?obj0 .\n    ?obj0 a city:BuildingInstallation .\n    ?obj0 city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?surface a city:WallSurface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^[2-4](\\\\.[0-4])?$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "BuildingPart lacks BuildingInstallation, or BuildingInstallation inside BuildingPart is missing WallSurface with LoD >= 2" ;
    sh:name "My sample rule for buildings" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasChild ?obj0 .
    ?obj0 a city:BuildingInstallation .
    ?obj0 city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?surface a city:WallSurface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^[2-4](\\\\.[0-4])?$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?obj0 a city:Building .
  ?obj0 city:hasChild ?this .
  ?this a city:BuildingPart .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ],
        [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ] .


```


### Minumum LoD 3 for objects whose identifiers begin with "ABC" or end with "DEF".
#### json
```json
{
  "id": "my-rule",
  "label": "Sample regex rule",
  "message": "Object has LoD less than 3",
  "objectSelector": {
    "idPatterns": [
      "^ABC.*",
      ".*DEF$"
    ]
  },
  "lod": {
    "min": "3"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "Sample regex rule",
      "description": null,
      "message": "Object has LoD less than 3",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  $this dct:identifier ?identifier .\n  { FILTER REGEX(?identifier, \"^ABC.*\") }\n  UNION\n  { FILTER REGEX(?identifier, \".*DEF$\") }\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?geometry city:lod ?lod .\n    FILTER REGEX(?lod, \"^[3-4](\\\\.[0-4])?$\")\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "Object has LoD less than 3" ;
    sh:name "Sample regex rule" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?geometry city:lod ?lod .
    FILTER REGEX(?lod, "^[3-4](\\\\.[0-4])?$")
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  $this dct:identifier ?identifier .
  { FILTER REGEX(?identifier, "^ABC.*") }
  UNION
  { FILTER REGEX(?identifier, ".*DEF$") }
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ] .


```


### Require that every Building has a WallSurface, but no specific LoD
#### json
```json
{
  "id": "my-rule",
  "label": "Only geometry requirement",
  "message": "Building has no WallSurface",
  "objectSelector": {
    "path": [
      "Building"
    ],
    "geometrySurface": "WallSurface"
  }
}
```

#### jsonld
```jsonld
{
  "@context": "https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld",
  "@graph": [
    {
      "@type": "sh:NodeShape",
      "id": "my-rule",
      "label": "Only geometry requirement",
      "description": null,
      "message": "Building has no WallSurface",
      "sh:target": {
        "@type": "sh:SPARQLTarget",
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT ?this WHERE {\n  ?this a city:Building .\n  ?this city:hasGeometry ?geometry .\n  ?geometry city:hasSurface ?surface .\n}"
      },
      "sh:sparql": {
        "sh:prefixes": {
          "@id": "my-rule:prefixes"
        },
        "sh:select": "\nSELECT $this (city:lod as ?path) (?lod as ?value) WHERE {\n  FILTER NOT EXISTS {\n    $this city:hasGeometry ?geometry .\n    ?geometry city:hasSurface ?surface .\n    ?surface a city:WallSurface .\n  }\n}"
      },
      "sh:severity": {
        "@id": "sh:Violation"
      }
    },
    {
      "@id": "prefixes",
      "@type": "owl:Ontology",
      "owl:imports": {
        "@id": "sh:"
      },
      "sh:declare": [
        {
          "sh:prefix": "city",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdf",
          "sh:namespace": {
            "@value": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "rdfs",
          "sh:namespace": {
            "@value": "http://www.w3.org/2000/01/rdf-schema#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "sd",
          "sh:namespace": {
            "@value": "https://w3id.org/okn/o/sd#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "attr",
          "sh:namespace": {
            "@value": "http://example.com/vocab/city/attr#",
            "@type": "xsd:anyURI"
          }
        },
        {
          "sh:prefix": "dct",
          "sh:namespace": {
            "@value": "http://purl.org/dc/terms/",
            "@type": "xsd:anyURI"
          }
        }
      ]
    }
  ]
}
```

#### ttl
```ttl
@prefix my-rule: <http://example.com/change-me/> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

my-rule:my-rule a sh:NodeShape ;
    sh:message "Building has no WallSurface" ;
    sh:name "Only geometry requirement" ;
    sh:severity sh:Violation ;
    sh:sparql [ sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT $this (city:lod as ?path) (?lod as ?value) WHERE {
  FILTER NOT EXISTS {
    $this city:hasGeometry ?geometry .
    ?geometry city:hasSurface ?surface .
    ?surface a city:WallSurface .
  }
}""" ] ;
    sh:target [ a sh:SPARQLTarget ;
            sh:prefixes my-rule:prefixes ;
            sh:select """
SELECT ?this WHERE {
  ?this a city:Building .
  ?this city:hasGeometry ?geometry .
  ?geometry city:hasSurface ?surface .
}""" ] .

my-rule:prefixes a owl:Ontology ;
    owl:imports sh: ;
    sh:declare [ sh:namespace "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xsd:anyURI ;
            sh:prefix "rdf" ],
        [ sh:namespace "http://example.com/vocab/city/"^^xsd:anyURI ;
            sh:prefix "city" ],
        [ sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            sh:prefix "dct" ],
        [ sh:namespace "http://www.w3.org/2000/01/rdf-schema#"^^xsd:anyURI ;
            sh:prefix "rdfs" ],
        [ sh:namespace "http://example.com/vocab/city/attr#"^^xsd:anyURI ;
            sh:prefix "attr" ],
        [ sh:namespace "https://w3id.org/okn/o/sd#"^^xsd:anyURI ;
            sh:prefix "sd" ] .


```

## Schema

```yaml
$schema: https://json-schema.org/draft/2020-12/schema
type: object
allOf:
- $ref: https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/base-rule/schema.yaml
- required:
  - objectSelector
  properties:
    objectSelector:
      allOf:
      - $ref: https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-selector/schema.yaml
      - type: object
        properties:
          requiredSubPath:
            description: Array with city object path, starting from the last element
              of "path", that is required to be present.
            minItems: 1
            $ref: https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-selector/schema.yaml#/$defs/CityObjectArray
          geometrySurface:
            description: Geometry surface on which the LoD will be checked.
            type: string
    lod:
      description: Level of detail
      type: object
      oneOf:
      - required:
        - regex
        properties:
          regex:
            description: Regular expression to validate the LoD.
            type: string
      - required:
        - min
        properties:
          min:
            description: Minimum allowed LoD. Can be simple (2) or extended (2.1).
              If extended an LoD is used, only extended values will be allowed.
            type: string
            pattern: ^[0-3](\.[0-3])?$

```

Links to the schema:

* YAML version: [schema.yaml](https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/schema.json)
* JSON version: [schema.json](https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/schema.yaml)


# JSON-LD Context

```jsonld
{
  "@context": {
    "@base": "http://example.com/change-me/",
    "id": "@id",
    "description": "sh:description",
    "message": "sh:message",
    "label": "sh:name",
    "sh": "http://www.w3.org/ns/shacl#",
    "my-rule": "http://example.com/change-me/",
    "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
    "dct": "http://purl.org/dc/terms/",
    "xsd": "http://www.w3.org/2001/XMLSchema#",
    "owl": "http://www.w3.org/2002/07/owl#",
    "city": "http://example.com/vocab/city/",
    "attr": "city:attr#",
    "sd": "https://w3id.org/okn/o/sd#",
    "chek": "urn:chek:vocab/",
    "@version": 1.1
  }
}
```

You can find the full JSON-LD context here:
[context.jsonld](https://ogcincubator.github.io/chek-profiles-bblocks/build/annotated/chekdbp/templates/object-lod/context.jsonld)


# For developers

The source code for this Building Block can be found in the following repository:

* URL: [https://github.com/ogcincubator/chek-profiles-bblocks](https://github.com/ogcincubator/chek-profiles-bblocks)
* Path: `_sources/templates/object-lod`

